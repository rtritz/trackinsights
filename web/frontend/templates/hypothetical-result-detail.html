{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-white pt-20 sm:pt-24 pb-24 sm:pb-32 px-2 sm:px-4">
  <div class="max-w-5xl mx-auto">
    <a href="{{ url_for('main.hypothetical_query_page') }}"
      class="fixed top-5 md:top-7 left-4 sm:left-5 md:left-10 z-[70] h-8 w-8 md:h-10 md:w-10 inline-flex items-center justify-center rounded-full border-2 border-[#8c0327] text-white bg-[#8c0327] shadow-md hover:bg-[#6b0220] transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
          clip-rule="evenodd" />
      </svg>
    </a>

    <div id="detail-root" class="hidden"
      data-event-name="{{ event_name }}"
      data-time-input="{{ time_input }}"
      data-gender="{{ gender }}"
      data-year="{{ year }}"
      data-meet-type="{{ meet_type }}"
      data-enrollment="{{ enrollment }}"
      data-grade-level="{{ grade_level }}"></div>

    <div id="loading-state" class="flex flex-col items-center justify-center min-h-[50vh]">
      <div class="loading loading-spinner loading-lg text-primary"></div>
      <p class="mt-4 text-lg text-gray-600">Crunching the numbers...</p>
    </div>

    <div id="error-state" class="hidden">
      <div class="flex flex-col items-center justify-center min-h-[50vh] text-center">
        <h2 class="font-impact italic text-primary text-4xl md:text-5xl font-bold mb-4">
          Result Not Available
        </h2>
        <p id="error-message" class="text-lg text-gray-600 mb-6">We couldn't generate rankings for this performance.</p>
        <a href="{{ url_for('main.hypothetical_query_page') }}"
          class="btn btn-primary rounded-full">Try a Different Performance</a>
      </div>
    </div>

    <div id="detail-content" class="hidden space-y-8">
      <!-- Summary Header -->
      <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-2xl sm:rounded-3xl p-6 sm:p-8 shadow-lg">
        <h1 id="result-title" class="font-impact italic text-primary text-3xl sm:text-4xl font-bold mb-2"></h1>
        <p id="result-subtitle" class="text-lg sm:text-xl text-gray-700 mb-3"></p>
        <div class="flex flex-wrap gap-2 text-sm sm:text-base text-gray-600" id="result-tags"></div>
      </div>

      <!-- Sectional Projections -->
      <div id="where-rank-card" class="card bg-white border border-base-200 shadow-sm overflow-hidden">
        <button id="where-rank-toggle" type="button"
          class="flex w-full flex-col items-start gap-2 sm:flex-row sm:items-center sm:justify-between sm:gap-3 px-5 py-4 text-left bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary border-b border-base-200 cursor-pointer"
          aria-controls="where-rank-panel" aria-expanded="false">
          <div>
            <h2 class="text-lg sm:text-xl font-semibold text-primary">Sectional Projections</h2>
          </div>
          <div class="flex items-center justify-between gap-2 sm:gap-3 text-sm font-medium text-gray-700 w-full sm:w-auto">
            <span id="where-rank-summary">No data yet</span>
            <svg id="where-rank-chevron" xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-500 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11l3.71-3.77a.75.75 0 111.08 1.04l-4.25 4.32a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg>
          </div>
        </button>
        <div id="where-rank-panel" class="card-body space-y-4 hidden">
          <p class="text-sm text-gray-600" id="where-rank-description">See how this performance would place at every
            sectional statewide.</p>
          <div class="overflow-x-auto">
            <table class="table w-full text-sm sm:text-base" id="where-rank-table">
              <thead>
                <tr class="text-primary text-sm sm:text-base uppercase">
                  <th class="w-1/3" data-column="projection-location">Sectional</th>
                  <th class="w-28">Projected Place</th>
                  <th class="w-24">Field Size</th>
                </tr>
              </thead>
              <tbody id="where-rank-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Overall Ranking -->
      <div id="rankings-container" class="grid gap-6 md:gap-8"></div>

      <!-- Try Another -->
      <div class="text-center pt-4">
        <a href="{{ url_for('main.hypothetical_query_page') }}"
          class="btn btn-outline btn-primary rounded-full px-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Try Another Performance
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const detailRoot = document.getElementById('detail-root');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    const detailContent = document.getElementById('detail-content');
    const rankingsContainer = document.getElementById('rankings-container');
    const whereRankCard = document.getElementById('where-rank-card');
    const whereRankToggle = document.getElementById('where-rank-toggle');
    const whereRankPanel = document.getElementById('where-rank-panel');
    const whereRankChevron = document.getElementById('where-rank-chevron');
    const whereRankSummary = document.getElementById('where-rank-summary');
    const whereRankTableBody = document.getElementById('where-rank-table-body');

    const eventName = detailRoot?.dataset?.eventName || '';
    const timeInput = detailRoot?.dataset?.timeInput || '';
    const gender = detailRoot?.dataset?.gender || '';
    const year = detailRoot?.dataset?.year || '';
    const meetType = detailRoot?.dataset?.meetType || 'Sectional';
    const enrollment = detailRoot?.dataset?.enrollment || '';
    const gradeLevel = detailRoot?.dataset?.gradeLevel || '';

    if (!eventName || !timeInput || !gender || !year) {
      loadingState.classList.add('hidden');
      errorMessage.textContent = 'Missing required parameters. Please go back and fill in all fields.';
      errorState.classList.remove('hidden');
      return;
    }

    try {
      const params = new URLSearchParams({
        event: eventName,
        time: timeInput,
        gender: gender,
        year: year,
        meet_type: meetType,
      });
      if (enrollment) params.set('enrollment', enrollment);
      if (gradeLevel) params.set('grade_level', gradeLevel);

      const response = await fetch(`/api/hypothetical-rank?${params.toString()}`);
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || 'Ranking data not found');
      }

      const data = await response.json();
      if (!data || !data.rankings) {
        throw new Error('Incomplete ranking payload');
      }

      loadingState.classList.add('hidden');
      detailContent.classList.remove('hidden');

      renderSummary(data);
      renderWhereDoIRank(data.where_do_i_rank, data.context);
      renderRankings(data.rankings, rankingsContainer, data.context);
    } catch (error) {
      console.error('Error loading ranking detail:', error);
      loadingState.classList.add('hidden');
      errorMessage.textContent = error.message || "We couldn't generate rankings for this performance.";
      errorState.classList.remove('hidden');
    }

    if (whereRankToggle && whereRankPanel && whereRankChevron) {
      whereRankToggle.addEventListener('click', () => {
        const isHidden = whereRankPanel.classList.toggle('hidden');
        const expanded = !isHidden;
        whereRankToggle.setAttribute('aria-expanded', expanded.toString());
        whereRankChevron.classList.toggle('rotate-180', expanded);
      });
    }

    function renderSummary(data) {
      const { context, target_result: target } = data;
      const titleEl = document.getElementById('result-title');
      const subtitleEl = document.getElementById('result-subtitle');
      const tagsEl = document.getElementById('result-tags');

      titleEl.textContent = `${context.event} • ${context.meet_type}`;
      subtitleEl.textContent = `${target.result} — Hypothetical Performance`;

      tagsEl.innerHTML = '';
      tagsEl.appendChild(buildTag(`Year: ${context.year}`));
      tagsEl.appendChild(buildTag(`Gender: ${context.gender || 'N/A'}`));
      tagsEl.appendChild(buildTag('Athlete: Hypothetical'));
      if (target.enrollment) {
        tagsEl.appendChild(buildTag(`Enrollment: ${target.enrollment}`));
      }
      if (target.grade) {
        tagsEl.appendChild(buildTag(`Grade: ${target.grade}`));
      }
    }

    function renderWhereDoIRank(whereData, context = {}) {
      if (!whereRankCard) return;
      if (!whereData || !Array.isArray(whereData.sectional_results) || !whereData.sectional_results.length) {
        whereRankCard.classList.add('hidden');
        return;
      }
      whereRankCard.classList.remove('hidden');

      const stageLabel = (context?.meet_type || 'Sectional').trim() || 'Sectional';
      const stageLabelLower = stageLabel.toLowerCase();
      const pluralStageLabel = stageLabelLower.endsWith('s') ? stageLabelLower : `${stageLabelLower}s`;
      const yearLabel = context?.year ? `${context.year}` : '';
      const combinedLabel = [yearLabel, stageLabel].filter(Boolean).join(' ').trim();
      const contextSuffix = combinedLabel ? ` (${combinedLabel})` : '';

      const projectionsHeading = whereRankCard.querySelector('h2');
      if (projectionsHeading) {
        const headingYearPrefix = yearLabel ? `${yearLabel} ` : '';
        projectionsHeading.textContent = `${headingYearPrefix}${stageLabel} Projections`;
      }

      const projectionsColumnHeader = document.querySelector('#where-rank-table thead th[data-column="projection-location"]');
      if (projectionsColumnHeader) {
        projectionsColumnHeader.textContent = stageLabel;
      }

      if (whereRankPanel) whereRankPanel.classList.add('hidden');
      if (whereRankToggle) whereRankToggle.setAttribute('aria-expanded', 'false');
      if (whereRankChevron) whereRankChevron.classList.remove('rotate-180');

      const sectionalResults = [...whereData.sectional_results];
      sectionalResults.sort((a, b) => {
        const aNum = Number(a?.meet_num);
        const bNum = Number(b?.meet_num);
        const aHasNum = Number.isFinite(aNum);
        const bHasNum = Number.isFinite(bNum);
        if (aHasNum && bHasNum && aNum !== bNum) return aNum - bNum;
        if (aHasNum && !bHasNum) return -1;
        if (!aHasNum && bHasNum) return 1;
        return (a?.sectional_name || '').localeCompare(b?.sectional_name || '');
      });

      const totalSectionals = sectionalResults.length;
      const projectedRanks = sectionalResults
        .map(r => Number(r.projected_place))
        .filter(v => Number.isFinite(v));

      const averageRank = projectedRanks.length
        ? projectedRanks.reduce((s, v) => s + v, 0) / projectedRanks.length
        : null;

      const summaryText = averageRank != null
        ? `Avg projected rank ${averageRank.toFixed(1)} over ${totalSectionals} ${pluralStageLabel}${contextSuffix}`
        : `${totalSectionals} ${pluralStageLabel}${contextSuffix}`;

      if (whereRankSummary) whereRankSummary.textContent = summaryText;

      const descriptionEl = document.getElementById('where-rank-description');
      if (descriptionEl) {
        const baseDescription = `See how this performance would place at every ${stageLabelLower} statewide`;
        descriptionEl.textContent = combinedLabel
          ? `${baseDescription} for ${combinedLabel}s.`
          : `${baseDescription}.`;
      }

      whereRankTableBody.innerHTML = '';
      sectionalResults.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'transition-colors duration-150 hover:bg-primary/5';

        const nameTd = document.createElement('td');
        nameTd.className = 'text-sm sm:text-base';
        nameTd.textContent = row.sectional_name || 'Sectional';
        tr.appendChild(nameTd);

        const placeTd = document.createElement('td');
        placeTd.className = 'text-sm sm:text-base';
        placeTd.textContent = row.projected_place_label || ordinal(row.projected_place);
        tr.appendChild(placeTd);

        const fieldTd = document.createElement('td');
        fieldTd.className = 'text-sm sm:text-base';
        fieldTd.textContent = row.field_size ? `${row.field_size} athletes` : '—';
        tr.appendChild(fieldTd);

        whereRankTableBody.appendChild(tr);
      });
    }

    function renderRankings(rankings, container, context = {}) {
      container.innerHTML = '';

      const configs = [
        { key: 'overall', title: 'Overall Rank', description: 'See how this hypothetical performance ranks among all participants for ' },
        { key: 'like_schools', title: 'Similar Enrollment Rank', description: 'See how this performance ranks among participants from schools of similar size for ' },
        { key: 'same_grade', title: 'Grade-Level Rank', description: 'See how this performance ranks among participants in the same grade level for ' },
      ];

      configs.forEach((config, index) => {
        const rankingData = rankings[config.key];
        const card = document.createElement('div');
        card.className = 'card bg-white border border-base-200 shadow-sm overflow-hidden';

        const detailId = `ranking-panel-${config.key}-${index}`;

        const summaryButton = document.createElement('button');
        summaryButton.type = 'button';
        summaryButton.className = 'flex w-full flex-col items-start gap-2 sm:flex-row sm:items-center sm:justify-between sm:gap-3 px-5 py-4 text-left bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary border-b border-base-200 cursor-pointer';
        summaryButton.setAttribute('aria-controls', detailId);
        summaryButton.setAttribute('aria-expanded', 'false');

        const summaryInfo = document.createElement('div');
        const title = document.createElement('h2');
        title.className = 'text-lg sm:text-xl font-semibold text-primary';
        const contextPrefix = context?.year && context?.meet_type ? `${context.year} ${context.meet_type} • ` : '';
        title.textContent = `${contextPrefix}${config.title}`;
        summaryInfo.appendChild(title);
        summaryButton.appendChild(summaryInfo);

        const summaryRight = document.createElement('div');
        summaryRight.className = 'flex items-center justify-between gap-2 sm:gap-3 text-sm font-medium text-gray-700 w-full sm:w-auto';

        const summaryRank = document.createElement('span');
        summaryRank.textContent = rankingData ? `Rank ${rankingData.rank} / ${rankingData.total}` : 'No data yet';
        summaryRight.appendChild(summaryRank);

        const chevron = buildChevronIcon();
        summaryRight.appendChild(chevron);

        summaryButton.appendChild(summaryRight);
        card.appendChild(summaryButton);

        const detail = document.createElement('div');
        detail.className = 'card-body space-y-4 hidden';
        detail.id = detailId;

        const description = document.createElement('p');
        description.className = 'text-sm text-gray-600';
        description.textContent = context?.year && context?.meet_type
          ? `${config.description} ${context.year} ${context.meet_type}s.`
          : config.description;
        detail.appendChild(description);

        if (!rankingData) {
          const empty = document.createElement('p');
          empty.className = 'text-sm text-gray-500 italic';
          empty.textContent = 'Not enough data to generate this ranking.';
          detail.appendChild(empty);
        } else {
          const headline = document.createElement('p');
          headline.className = 'text-lg sm:text-xl font-semibold text-gray-800';
          headline.textContent = `Ranked ${rankingData.rank} of ${rankingData.total}`;
          detail.appendChild(headline);

          if (rankingData.criteria) {
            const chips = document.createElement('div');
            chips.className = 'flex flex-wrap gap-2 text-xs sm:text-sm';
            Object.entries(rankingData.criteria).forEach(([key, value]) => {
              chips.appendChild(buildTag(`${formatLabel(key)}: ${value}`));
            });
            detail.appendChild(chips);
          }

          detail.appendChild(buildLeaderboardTable(rankingData.top_results));
        }

        summaryButton.addEventListener('click', () => {
          const isHidden = detail.classList.toggle('hidden');
          const expanded = !isHidden;
          summaryButton.setAttribute('aria-expanded', expanded.toString());
          chevron.classList.toggle('rotate-180', expanded);
        });

        card.appendChild(detail);
        container.appendChild(card);
      });
    }

    function buildLeaderboardTable(entries) {
      const wrapper = document.createElement('div');
      wrapper.className = 'overflow-x-auto';

      const table = document.createElement('table');
      table.className = 'table table-compact w-full text-sm sm:text-base';

      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr class="text-primary text-sm sm:text-base uppercase">
          <th class="w-16">Rank</th>
          <th class="whitespace-nowrap">Athlete</th>
          <th class="whitespace-nowrap">School</th>
          <th>Result</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      entries.forEach(entry => {
        const tr = document.createElement('tr');
        const rowBaseClass = 'transition-colors duration-150 hover:bg-primary/5';
        tr.className = entry.is_target
          ? `${rowBaseClass} bg-primary/10 text-primary font-semibold`
          : rowBaseClass;

        const rankTd = document.createElement('td');
        rankTd.textContent = entry.rank;
        rankTd.className = 'text-sm sm:text-base';
        tr.appendChild(rankTd);

        const nameTd = document.createElement('td');
        nameTd.className = 'text-sm sm:text-base';
        nameTd.textContent = entry.name || '—';
        tr.appendChild(nameTd);

        const schoolTd = document.createElement('td');
        schoolTd.className = 'hidden sm:table-cell text-sm sm:text-base';
        schoolTd.textContent = entry.school || '—';
        tr.appendChild(schoolTd);

        const resultTd = document.createElement('td');
        resultTd.className = 'text-sm sm:text-base';
        resultTd.textContent = entry.result || '—';
        tr.appendChild(resultTd);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      return wrapper;
    }

    function buildChevronIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 20 20');
      svg.setAttribute('fill', 'currentColor');
      svg.setAttribute('aria-hidden', 'true');
      svg.classList.add('h-5', 'w-5', 'text-gray-500', 'transition-transform', 'duration-200');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('fill-rule', 'evenodd');
      path.setAttribute('clip-rule', 'evenodd');
      path.setAttribute('d', 'M5.23 7.21a.75.75 0 011.06.02L10 11l3.71-3.77a.75.75 0 111.08 1.04l-4.25 4.32a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z');
      svg.appendChild(path);
      return svg;
    }

    function buildTag(text) {
      const span = document.createElement('span');
      span.className = 'badge badge-outline rounded-full px-3 py-2 h-auto min-h-[2.25rem] whitespace-normal break-words text-left';
      span.textContent = text;
      return span;
    }

    function formatLabel(label) {
      return label.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function ordinal(value) {
      if (value == null) return '—';
      const n = Number(value);
      if (!Number.isFinite(n)) return '—';
      const mod100 = n % 100;
      const suffix = (mod100 >= 11 && mod100 <= 13)
        ? 'th'
        : { 1: 'st', 2: 'nd', 3: 'rd' }[n % 10] || 'th';
      return `${n}${suffix}`;
    }
  });
</script>
{% endblock %}
