{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-white pt-5 pb-5 px-3 sm:px-6">
  <div class="pt-15 relative max-w-6xl mx-auto">
    <div
      class="absolute inset-0 -z-10 mx-0 sm:mx-[-40px] rounded-[48px] bg-gradient-to-b from-primary/5 via-transparent to-base-200/40 blur-3xl opacity-80 pointer-events-none">
    </div>
    <div class="relative space-y-8">
      <a href="{{ url_for('main.queries_page') }}"
        class="inline-flex items-center gap-1 text-primary hover:text-primary/80 hover:underline font-semibold mb-4 mt-4 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd" />
        </svg>
        Back
      </a>
      <header class="text-center space-y-4">
        <h1 class="font-impact italic text-4xl sm:text-5xl text-primary">
          Query: Track & Field Percentiles
        </h1>

      </header>

      <div class="rounded-[32px] bg-white/90 ring-1 ring-base-200 shadow-[0_25px_70px_rgba(15,23,42,0.08)] p-4 sm:p-6">
        <div class="flex flex-wrap lg:flex-nowrap gap-6 items-stretch">
          <section
            class="bg-white border border-base-200/80 rounded-2xl shadow-lg shadow-base-300/40 w-full lg:w-[22rem] xl:w-[24rem] shrink-0 flex flex-col">
            <div class="gap-0 p-4 flex-1 flex flex-col" id="percentile-filter-card">
              <div class="flex items-center justify-between">
                <div></div>
                <button type="button" id="clear-all" class="btn btn-ghost btn-sm text-sm">Reset filters</button>
              </div>

              <fieldset class="space-y-2">
                <legend class="sr-only">Events</legend>
                <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-gray-500">
                  <span>Events</span>
                </div>
                <div id="event-chip-group" class="grid grid-cols-1 sm:grid-cols-2 gap-1.5"></div>
              </fieldset>

              <fieldset class="space-y-2">
                <legend class="sr-only">Meet types</legend>
                <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-gray-500">
                  <span>Meet Types</span>
                  <button type="button" id="meet-select-all" class="btn btn-ghost btn-xs text-[10px] px-2"
                    aria-label="Select all meet types">Select all meet types</button>
                </div>
                <div id="meet-chip-group" class="flex flex-wrap gap-1.5"></div>
              </fieldset>

              <fieldset class="space-y-2">
                <legend class="sr-only">Grade levels</legend>
                <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-gray-500">
                  <span>Grade Levels</span>
                  <button type="button" id="grade-select-all" class="btn btn-ghost btn-xs text-[10px] px-2"
                    aria-label="Select all grade levels">Select all grades</button>
                </div>
                <div id="grade-chip-group" class="flex flex-wrap gap-1.5"></div>
              </fieldset>

              <fieldset class="space-y-2">
                <legend class="sr-only">Seasons</legend>
                <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-gray-500">
                  <span>Seasons</span>
                  <button type="button" id="year-select-all" class="btn btn-ghost btn-xs text-[10px] px-2"
                    aria-label="Select all seasons">Select all seasons</button>
                </div>
                <div id="year-chip-group" class="flex flex-wrap gap-1.5"></div>
              </fieldset>
            </div>
          </section>

          <section
            class="bg-white border border-base-200/80 rounded-2xl shadow-xl shadow-base-300/30 min-h-[520px] flex-1 min-w-0 lg:max-w-[48rem] flex flex-col">
            <div class="space-y-4 p-4 flex-1 flex flex-col">
              <div class="flex flex-wrap items-center justify-between gap-3 text-sm text-gray-600">
                <div id="results-summary" class="hidden">Select an event to view percentiles…</div>
                <button type="button" id="copy-query" class="btn btn-xs btn-outline">Copy query URL</button>
              </div>

              <div id="results-error" class="hidden alert alert-error">
                <span id="results-error-message">Something went wrong.</span>
              </div>

              <div class="relative flex-1 flex flex-col">
                <div id="results-loading" class="hidden absolute inset-0 bg-white/80 z-10">
                  <div class="flex flex-col items-center justify-center h-full text-center">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="mt-3 text-sm text-gray-500">Crunching numbers…</p>
                  </div>
                </div>
                <div class="overflow-x-auto border border-base-200 rounded-lg flex-1">
                  <table class="table table-zebra text-sm">
                    <thead id="results-head"></thead>
                    <tbody id="results-body"></tbody>
                  </table>
                </div>
                <div class="mt-4 space-y-2">
                  <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-gray-500">
                    <span>Percentile Granularity</span>
                    <span id="percentile-slider-value" class="text-sm font-semibold text-primary">Every 25%</span>
                  </div>
                  <input type="range" id="percentile-slider" min="0" max="5" step="1" value="3"
                    class="range range-primary range-xs w-full" aria-label="Percentile granularity selector"
                    draggable="false">
                  <div class="flex justify-between text-[11px] text-gray-500 font-medium w-full">
                    <span>1%</span>
                    <span>5%</span>
                    <span>10%</span>
                    <span>25%</span>
                    <span>33%</span>
                    <span>50%</span>
                  </div>
                </div>
                <p id="results-status" class="text-[12px] text-gray-500 mt-3">
                  Filters update automatically. Boys and Girls are compared side-by-side.
                </p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const eventChipGroup = document.getElementById('event-chip-group');
    const meetChipGroup = document.getElementById('meet-chip-group');
    const gradeChipGroup = document.getElementById('grade-chip-group');
    const yearChipGroup = document.getElementById('year-chip-group');
    const percentileSlider = document.getElementById('percentile-slider');
    const percentileSliderValue = document.getElementById('percentile-slider-value');
  const meetSelectAllBtn = document.getElementById('meet-select-all');
  const gradeSelectAllBtn = document.getElementById('grade-select-all');
  const yearSelectAllBtn = document.getElementById('year-select-all');
    const clearAllBtn = document.getElementById('clear-all');
    const resultsLoading = document.getElementById('results-loading');
    const resultsError = document.getElementById('results-error');
    const resultsErrorMessage = document.getElementById('results-error-message');
    const resultsSummary = document.getElementById('results-summary');
    const resultsStatus = document.getElementById('results-status');
    const resultsHead = document.getElementById('results-head');
    const resultsBody = document.getElementById('results-body');
    const copyQueryBtn = document.getElementById('copy-query');

    const chipBaseClasses = 'chip-btn btn btn-xs border border-base-300 text-sm whitespace-nowrap px-3 py-1.5 transition-colors justify-center text-center shadow-none hover:shadow-none focus:shadow-none';
    const eventChipClasses = 'chip-btn btn btn-xs border border-base-300 text-sm w-full px-3 py-2 transition-colors justify-center text-center shadow-none hover:shadow-none focus:shadow-none';
    const DEFAULT_MEET_TYPE_SELECTIONS = ['Sectional', 'Regional', 'State'];
    const DEFAULT_GRADE_SELECTIONS = ['Freshman', 'Sophomore', 'Junior', 'Senior', 'FR', 'SO', 'JR', 'SR'];
    let defaultYearSelections = [];
    const EVENT_GROUPS = [
      {
        label: 'Sprints & Distance',
        events: ['100 Meters', '200 Meters', '400 Meters', '800 Meters', '1600 Meters', '3200 Meters'],
      },
      {
        label: 'Hurdles',
        events: ['100 Hurdles', '110 Hurdles', '300 Hurdles'],
      },
      {
        label: 'Relays',
        events: ['4 x 100 Relay', '4 x 400 Relay', '4 x 800 Relay'],
      },
      {
        label: 'Field Events',
        events: ['High Jump', 'Long Jump', 'Pole Vault', 'Shot Put', 'Discus'],
      },
    ];
    const YEAR_DISPLAY_ORDER = ['2023', '2024', '2025'];
    const PERCENTILE_STEP_OPTIONS = [1, 5, 10, 25, 33, 50];
    const DEFAULT_PERCENTILE_STEP = 25;
    const EVENT_GENDER_OVERRIDES = {
      '100 Hurdles': {
        Boys: '110 Hurdles',
        Girls: '100 Hurdles',
      },
    };

    const parseQueryList = (params, key, transform = value => value) => {
      const raw = params.get(key);
      if (!raw) {
        return [];
      }
      return raw
        .split(',')
        .map(piece => transform(piece.trim()))
        .filter(value => value !== null && value !== undefined && value !== '');
    };

    const parseInitialFilters = () => {
      const params = new URLSearchParams(window.location.search || '');
      return {
        events: parseQueryList(params, 'events'),
        meet_types: parseQueryList(params, 'meet_types'),
        grade_levels: parseQueryList(params, 'grade_levels'),
        years: parseQueryList(params, 'years'),
        percentiles: parseQueryList(params, 'percentiles', value => {
          const parsed = Number(value);
          return Number.isFinite(parsed) ? parsed : null;
        }),
      };
    };

    const buildPercentileValues = (step = DEFAULT_PERCENTILE_STEP) => {
      const numericStep = Number(step) || DEFAULT_PERCENTILE_STEP;
      const values = [];
      for (let value = numericStep; value < 100; value += numericStep) {
        values.push(value);
      }
      return values;
    };

    const state = {
      options: null,
      lastQuery: '',
      fetchTimeout: null,
      columns: ['Gender', 'Event', '25', '50', '75'],
      selectedEvent: null,
      percentileStep: DEFAULT_PERCENTILE_STEP,
      percentiles: buildPercentileValues(DEFAULT_PERCENTILE_STEP),
    };

    const initialFilters = parseInitialFilters();

    const orderEvents = (events = []) => {
      const priorityEntries = EVENT_GROUPS.flatMap((group, groupIndex) =>
        group.events.map((name, eventIndex) => [name, groupIndex * 100 + eventIndex])
      );
      const priority = new Map(priorityEntries);
      return [...events].sort((a = '', b = '') => {
        const aRank = priority.has(a) ? priority.get(a) : Number.MAX_SAFE_INTEGER;
        const bRank = priority.has(b) ? priority.get(b) : Number.MAX_SAFE_INTEGER;
        if (aRank !== bRank) {
          return aRank - bRank;
        }
        return a.localeCompare(b);
      });
    };

    const orderYears = (years = []) => {
      const normalized = years.map(year => year?.toString()).filter(Boolean);
      const prioritized = YEAR_DISPLAY_ORDER.filter(year => normalized.includes(year));
      const remaining = normalized.filter(year => !YEAR_DISPLAY_ORDER.includes(year)).sort((a, b) => Number(b) - Number(a));
      return [...prioritized, ...remaining];
    };

    const insertGroupDividers = (container) => {
      const divider = document.createElement('div');
      divider.className = 'col-span-full border-t border border-1 border-base-200/80 ';
      container.appendChild(divider);
    };

    const updatePercentileSliderLabel = () => {
      if (!percentileSliderValue) {
        return;
      }
      const step = state.percentileStep || DEFAULT_PERCENTILE_STEP;
      percentileSliderValue.textContent = `Every ${step}%`;
    };

    const syncPercentileSlider = () => {
      if (!percentileSlider) {
        return;
      }
      const currentStep = state.percentileStep || DEFAULT_PERCENTILE_STEP;
      const index = PERCENTILE_STEP_OPTIONS.indexOf(currentStep);
      percentileSlider.value = String(index >= 0 ? index : 0);
      updatePercentileSliderLabel();
    };

    const applyPercentileStep = (step) => {
      const normalizedStep = PERCENTILE_STEP_OPTIONS.find(option => Math.abs(option - step) < 0.01) || DEFAULT_PERCENTILE_STEP;
      if (state.percentileStep === normalizedStep && Array.isArray(state.percentiles) && state.percentiles.length) {
        updatePercentileSliderLabel();
        return false;
      }
      state.percentileStep = normalizedStep;
      state.percentiles = buildPercentileValues(normalizedStep);
      updatePercentileSliderLabel();
      return true;
    };

    const applyPercentilesFromQuery = (values) => {
      if (!Array.isArray(values) || !values.length) {
        return false;
      }
      const normalized = values
        .map(value => Number(value))
        .filter(value => Number.isFinite(value) && value > 0 && value < 100)
        .sort((a, b) => a - b);
      if (!normalized.length) {
        return false;
      }
      const matchingStep = PERCENTILE_STEP_OPTIONS.find(option => {
        const expected = buildPercentileValues(option);
        return expected.length === normalized.length && expected.every((value, index) => value === normalized[index]);
      });
      if (matchingStep) {
        applyPercentileStep(matchingStep);
        return true;
      }
      state.percentiles = normalized;
      state.percentileStep = normalized[0] || DEFAULT_PERCENTILE_STEP;
      updatePercentileSliderLabel();
      return true;
    };

    const copyTextToClipboard = async (text) => {
      const fallbackCopy = () => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          const successful = document.execCommand('copy');
          document.body.removeChild(textarea);
          return successful;
        } catch (error) {
          document.body.removeChild(textarea);
          return false;
        }
      };

      if (navigator?.clipboard?.writeText && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (error) {
          console.warn('Secure clipboard copy failed, falling back', error);
          return fallbackCopy();
        }
      }

      return fallbackCopy();
    };

    const toTitleCase = (text = '') =>
      text
        .split(' ')
        .map(word => (word ? word[0].toUpperCase() + word.slice(1).toLowerCase() : ''))
        .join(' ');

    const fetchJson = async (url) => {
      const response = await fetch(url);
      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        const message = payload.error || `Request failed (${response.status})`;
        throw new Error(message);
      }
      return response.json();
    };

    const setChipSelected = (chip, isSelected) => {
      chip.dataset.selected = isSelected ? 'true' : 'false';
      chip.classList.toggle('btn-primary', isSelected);
      chip.classList.toggle('btn-outline', !isSelected);
      chip.classList.toggle('btn-ghost', !isSelected);
      chip.classList.toggle('text-white', isSelected);
      chip.classList.toggle('text-base-content', !isSelected);
    };

    const getSelectedChipCount = (container) => {
      if (!container) {
        return 0;
      }
      return container.querySelectorAll('.chip-btn[data-selected="true"]').length;
    };

    const createChip = (value, container, options = {}) => {
      const { enforceMinOne = false } = options;
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = chipBaseClasses;
      chip.dataset.value = value;
      chip.dataset.selected = 'false';
      chip.textContent = value;
      chip.addEventListener('click', () => {
        const isSelected = chip.dataset.selected === 'true';
        if (enforceMinOne && isSelected && getSelectedChipCount(container) <= 1) {
          return;
        }
        const nextState = !isSelected;
        setChipSelected(chip, nextState);
        queueFetch();
      });
      container.appendChild(chip);
      setChipSelected(chip, false);
      return chip;
    };

    const syncEventSelection = () => {
      Array.from(eventChipGroup.querySelectorAll('.chip-btn')).forEach(chip => {
        const isSelected = chip.dataset.value === state.selectedEvent;
        setChipSelected(chip, isSelected);
      });
    };

    const renderEventChips = (events) => {
      eventChipGroup.innerHTML = '';
      const orderedEvents = orderEvents(events);
      const groupsLookup = new Map();
      EVENT_GROUPS.forEach(group => {
        group.events.forEach(eventName => {
          groupsLookup.set(eventName, group.label);
        });
      });

      let previousGroupLabel = null;
      orderedEvents.forEach(eventName => {
        const currentLabel = groupsLookup.get(eventName) || null;
        if (previousGroupLabel !== null && currentLabel && currentLabel !== previousGroupLabel) {
          insertGroupDividers(eventChipGroup);
        }

        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = eventChipClasses;
        chip.dataset.value = eventName;
        chip.textContent = eventName;
        chip.addEventListener('click', () => {
          state.selectedEvent = state.selectedEvent === eventName ? null : eventName;
          syncEventSelection();
          queueFetch();
        });
        eventChipGroup.appendChild(chip);
        setChipSelected(chip, state.selectedEvent === eventName);

        previousGroupLabel = currentLabel || previousGroupLabel;
      });

      if (!state.selectedEvent && orderedEvents.length) {
        state.selectedEvent = orderedEvents[0];
        syncEventSelection();
        queueFetch();
      }
    };

    const renderChipGroup = (values, container, options = {}) => {
      if (!container) {
        return;
      }
      container.innerHTML = '';
      values.forEach(value => {
        createChip(value, container, options);
      });
    };

    const applyDefaultSelections = (container, defaults = []) => {
      if (!container || !defaults.length) {
        return;
      }
      const normalized = defaults
        .map(value => value?.toString().trim().toLowerCase())
        .filter(Boolean);
      Array.from(container.querySelectorAll('.chip-btn')).forEach(chip => {
        const chipValue = chip.dataset.value?.toString().trim().toLowerCase();
        if (chipValue && normalized.includes(chipValue)) {
          setChipSelected(chip, true);
        }
      });
    };

    const getEventQueryList = () => {
      if (!state.selectedEvent) {
        return [];
      }
      const overrides = EVENT_GENDER_OVERRIDES[state.selectedEvent];
      if (!overrides) {
        return [state.selectedEvent];
      }
      const requested = [state.selectedEvent, ...Object.values(overrides).filter(Boolean)];
      return Array.from(new Set(requested));
    };

    const getSelectedChips = (container) => {
      if (!container) {
        return [];
      }
      return Array.from(container.querySelectorAll('.chip-btn[data-selected="true"]')).map(chip => chip.dataset.value);
    };

    const collectQueryParams = () => {
      return {
        events: getEventQueryList(),
        genders: (state.options?.genders || []).filter(Boolean),
        meet_types: getSelectedChips(meetChipGroup),
        grade_levels: getSelectedChips(gradeChipGroup),
        years: getSelectedChips(yearChipGroup),
        percentiles: state.percentiles,
      };
    };

    const buildQueryString = (params) => {
      const query = new URLSearchParams();
      Object.entries(params).forEach(([key, values]) => {
        if (!values || values.length === 0) {
          return;
        }
        query.set(key, values.join(','));
      });
      return query.toString();
    };

    const describePercentiles = () => {
      const step = state.percentileStep || DEFAULT_PERCENTILE_STEP;
      const label = step % 1 === 0 ? step.toString() : step.toFixed(2).replace(/0+$/, '').replace(/\.$/, '');
      return `every ${label}% percentile`;
    };

    const showLoading = (isLoading) => {
      resultsLoading.classList.toggle('hidden', !isLoading);
    };

    const showError = (message) => {
      if (message) {
        resultsError.classList.remove('hidden');
        resultsErrorMessage.textContent = message;
      } else {
        resultsError.classList.add('hidden');
      }
    };

    const renderTableSkeleton = () => {
      resultsHead.innerHTML = '<tr><th class="text-xs uppercase tracking-wide">Percentile</th><th class="text-xs uppercase tracking-wide">Boys</th><th class="text-xs uppercase tracking-wide">Girls</th></tr>';
      resultsBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-8">Select an event to start comparing.</td></tr>`;
    };

    const deriveGenderOrder = (rows) => {
      const preferred = (state.options?.genders || ['Boys', 'Girls']).filter(Boolean);
      const present = [];
      rows.forEach(row => {
        const gender = row.Gender || row.gender;
        if (gender && !present.includes(gender)) {
          present.push(gender);
        }
      });

      const baseOrder = preferred.length ? [...preferred] : [...present];
      present.forEach(gender => {
        if (!baseOrder.includes(gender)) {
          baseOrder.push(gender);
        }
      });
      return baseOrder;
    };

    const renderResults = (payload) => {
      if (!state.selectedEvent) {
        renderTableSkeleton();
        resultsSummary.textContent = 'No event selected';
        if (resultsStatus) {
          resultsStatus.textContent = 'Select an event on the left to view Boys vs. Girls percentiles. Use the filters to narrow by meet type, grade level, and season.';
        }
        return;
      }

      const { columns = state.columns, rows = [], filters = {}, result_count = 0 } = payload || {};
      if (Array.isArray(columns) && columns.length) {
        state.columns = columns;
      }

      const metricColumns = state.columns.filter(column => !['Gender', 'Event'].includes(column));
      const activeMetrics = metricColumns.length ? metricColumns : ['25', '50', '75'];
      const genders = deriveGenderOrder(rows);
      const rowByGender = new Map();
      const overrides = EVENT_GENDER_OVERRIDES[state.selectedEvent] || {};
      rows.forEach(row => {
        const gender = row.Gender || row.gender;
        if (!gender) {
          return;
        }
        const preferredEvent = overrides[gender];
        const rowEvent = row.Event || row.event;
        const existing = rowByGender.get(gender);

        if (preferredEvent) {
          if (rowEvent === preferredEvent) {
            rowByGender.set(gender, row);
            return;
          }
          if (!existing) {
            rowByGender.set(gender, row);
          }
          return;
        }

        if (!existing) {
          rowByGender.set(gender, row);
        }
      });

      const headers = ['Percentile', ...genders];
      resultsHead.innerHTML = '<tr>' + headers.map(column => `<th class="text-xs uppercase tracking-wide">${column}</th>`).join('') + '</tr>';

      if (!genders.length || !rows.length) {
        resultsBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center text-gray-400 py-8">No results matched these filters.</td></tr>`;
      } else {
        resultsBody.innerHTML = activeMetrics
          .map(metric => {
            const cells = genders
              .map(gender => {
                const source = rowByGender.get(gender);
                return `<td>${source && source[metric] ? source[metric] : '—'}</td>`;
              })
              .join('');
            return `<tr><td class="font-semibold text-xs uppercase tracking-wide">${metric}</td>${cells}</tr>`;
          })
          .join('');
      }

      const normalizedFilters = { ...filters };
      if (state.selectedEvent) {
        normalizedFilters.events = [state.selectedEvent];
      }

      const activeFilters = Object.entries(normalizedFilters)
        .map(([key, value]) => `${key}: ${Array.isArray(value) ? value.join(', ') : value}`)
        .join(' | ');
      const genderLabel = genders.length ? genders.join(' vs ') : 'No gender data';
      const summaryText = `${state.selectedEvent || 'No event'} | ${genderLabel} | ${activeFilters || 'All meet/grade levels'}`;
      resultsSummary.textContent = toTitleCase(summaryText);
      // resultsStatus.textContent = `Showing Boys and Girls side-by-side using ${describePercentiles()}.`;
    };

    const fetchPercentiles = async () => {
      if (!state.selectedEvent) {
        renderTableSkeleton();
        resultsSummary.textContent = 'No event selected';
        if (resultsStatus) {
          resultsStatus.textContent = 'Pick an event on the left to compare Boys vs Girls percentiles.';
        }
        state.lastQuery = '';
        return;
      }

      const params = collectQueryParams();

      const query = buildQueryString(params);
      state.lastQuery = query;

      showError(null);
      showLoading(true);

      try {
        const endpoint = query ? `/api/percentiles?${query}` : '/api/percentiles';
        const payload = await fetchJson(endpoint);
        renderResults(payload);
      } catch (error) {
        showError(error.message);
      } finally {
        showLoading(false);
      }
    };

    const queueFetch = () => {
      if (state.fetchTimeout) {
        clearTimeout(state.fetchTimeout);
      }
      state.fetchTimeout = setTimeout(fetchPercentiles, 200);
    };

    if (percentileSlider) {
      const handleSliderChange = () => {
        const raw = Number(percentileSlider.value);
        const index = Math.min(
          Math.max(Math.round(Number.isFinite(raw) ? raw : 0), 0),
          PERCENTILE_STEP_OPTIONS.length - 1,
        );
        percentileSlider.value = String(index);
        const nextStep = PERCENTILE_STEP_OPTIONS[index] || DEFAULT_PERCENTILE_STEP;
        const changed = applyPercentileStep(nextStep);
        if (changed) {
          queueFetch();
        }
      };
      percentileSlider.addEventListener('input', handleSliderChange);
      percentileSlider.addEventListener('change', handleSliderChange);
      syncPercentileSlider();
    } else {
      updatePercentileSliderLabel();
    }

    const clearChips = (container) => {
      if (!container) {
        return;
      }
      Array.from(container.querySelectorAll('.chip-btn')).forEach(chip => {
        setChipSelected(chip, false);
      });
    };

    const selectAllChips = (container) => {
      if (!container) {
        return false;
      }
      let changed = false;
      Array.from(container.querySelectorAll('.chip-btn')).forEach(chip => {
        if (chip.dataset.selected !== 'true') {
          setChipSelected(chip, true);
          changed = true;
        }
      });
      return changed;
    };

    const ensureAtLeastOneSelected = (container) => {
      if (!container) {
        return;
      }
      if (getSelectedChipCount(container) === 0) {
        const firstChip = container.querySelector('.chip-btn');
        if (firstChip) {
          setChipSelected(firstChip, true);
        }
      }
    };

    const resetFilters = () => {
      clearChips(meetChipGroup);
      clearChips(gradeChipGroup);
      clearChips(yearChipGroup);
      state.selectedEvent = state.options?.events?.[0] || null;
      syncEventSelection();
      applyDefaultSelections(meetChipGroup, DEFAULT_MEET_TYPE_SELECTIONS);
      ensureAtLeastOneSelected(meetChipGroup);
      applyDefaultSelections(gradeChipGroup, DEFAULT_GRADE_SELECTIONS);
      ensureAtLeastOneSelected(gradeChipGroup);
      applyDefaultSelections(yearChipGroup, defaultYearSelections);
      ensureAtLeastOneSelected(yearChipGroup);
      applyPercentileStep(DEFAULT_PERCENTILE_STEP);
      syncPercentileSlider();
      queueFetch();
    };

    if (meetSelectAllBtn) {
      meetSelectAllBtn.addEventListener('click', () => {
        const changed = selectAllChips(meetChipGroup);
        if (changed) {
          queueFetch();
        }
      });
    }

    if (gradeSelectAllBtn) {
      gradeSelectAllBtn.addEventListener('click', () => {
        const changed = selectAllChips(gradeChipGroup);
        if (changed) {
          queueFetch();
        }
      });
    }

    if (yearSelectAllBtn) {
      yearSelectAllBtn.addEventListener('click', () => {
        const changed = selectAllChips(yearChipGroup);
        if (changed) {
          queueFetch();
        }
      });
    }

    clearAllBtn.addEventListener('click', resetFilters);

    copyQueryBtn.addEventListener('click', async () => {
      if (!state.selectedEvent) {
        copyQueryBtn.textContent = 'Select an event first';
        setTimeout(() => (copyQueryBtn.textContent = 'Copy query URL'), 1800);
        return;
      }

      const params = collectQueryParams();
      const query = buildQueryString(params);
      if (!query) {
        copyQueryBtn.textContent = 'No filters yet';
        setTimeout(() => (copyQueryBtn.textContent = 'Copy query URL'), 1800);
        return;
      }

      const path = '/queries/percentiles';
      const url = `${window.location.origin}${path}?${query}`;
      const success = await copyTextToClipboard(url);
      copyQueryBtn.textContent = success ? 'Copied!' : 'Copy failed';
      setTimeout(() => (copyQueryBtn.textContent = 'Copy query URL'), 1800);
    });

    const bootstrap = async () => {
      renderTableSkeleton();
      try {
        const options = await fetchJson('/api/percentiles/options');
        const orderedEvents = orderEvents(options.events || []);
        state.options = { ...options, events: orderedEvents };
        const requestedEvent = initialFilters.events.find(eventName => orderedEvents.includes(eventName));
        if (requestedEvent) {
          state.selectedEvent = requestedEvent;
        } else if (!state.selectedEvent && orderedEvents.length) {
          state.selectedEvent = orderedEvents[0];
        }
        renderEventChips(orderedEvents);
  renderChipGroup(options.meet_types || [], meetChipGroup, { enforceMinOne: true });
        const meetDefaults = initialFilters.meet_types.length ? initialFilters.meet_types : DEFAULT_MEET_TYPE_SELECTIONS;
        applyDefaultSelections(meetChipGroup, meetDefaults);
        ensureAtLeastOneSelected(meetChipGroup);
  renderChipGroup(options.grade_levels || [], gradeChipGroup, { enforceMinOne: true });
        const gradeDefaults = initialFilters.grade_levels.length ? initialFilters.grade_levels : DEFAULT_GRADE_SELECTIONS;
        applyDefaultSelections(gradeChipGroup, gradeDefaults);
        ensureAtLeastOneSelected(gradeChipGroup);
        const orderedYears = orderYears(options.years || []);
  renderChipGroup(orderedYears, yearChipGroup, { enforceMinOne: true });
        defaultYearSelections = YEAR_DISPLAY_ORDER.filter(year => orderedYears.includes(year));
        if (!defaultYearSelections.length) {
          defaultYearSelections = [...orderedYears];
        }
        const yearDefaults = initialFilters.years.length ? initialFilters.years : defaultYearSelections;
        applyDefaultSelections(yearChipGroup, yearDefaults);
        ensureAtLeastOneSelected(yearChipGroup);
        const hadCustomPercentiles = applyPercentilesFromQuery(initialFilters.percentiles);
        if (!hadCustomPercentiles) {
          applyPercentileStep(DEFAULT_PERCENTILE_STEP);
        }
        syncPercentileSlider();
      } catch (error) {
        showError(error.message);
        resultsSummary.textContent = 'Unable to load options';
      }
      queueFetch();
    };

    bootstrap();
  });
</script>
{% endblock %}