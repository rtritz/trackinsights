{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-white pt-20 sm:pt-24 pb-24 sm:pb-32 px-2 sm:px-4">
  <div class="max-w-5xl mx-auto">
    <a href="{{ url_for('main.athlete_dashboard', athlete_id=athlete_id) }}" class="inline-flex items-center gap-1 text-primary hover:text-primary/80 hover:underline font-semibold mb-6 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
      </svg>
      Back to Athlete Dashboard
    </a>

    <div id="detail-root"
         class="hidden"
         data-athlete-id="{{ athlete_id }}"
         data-meet-id="{{ meet_id }}"
         data-event-name="{{ event_name }}"
         data-result-type="{{ result_type }}"></div>

    <div id="loading-state" class="flex flex-col items-center justify-center min-h-[50vh]">
      <div class="loading loading-spinner loading-lg text-primary"></div>
      <p class="mt-4 text-lg text-gray-600">Crunching the numbers...</p>
    </div>

    <div id="error-state" class="hidden">
      <div class="flex flex-col items-center justify-center min-h-[50vh] text-center">
        <h2 class="font-impact italic text-primary text-4xl md:text-5xl font-bold mb-4" style="font-family: Impact, 'Arial Black', sans-serif;">
          Result Not Available
        </h2>
        <p class="text-lg text-gray-600 mb-6">We couldn't generate rankings for this performance.</p>
        <a href="{{ url_for('main.athlete_dashboard', athlete_id=athlete_id) }}" class="btn btn-primary rounded-full">Return to Dashboard</a>
      </div>
    </div>

    <div id="detail-content" class="hidden space-y-8">
      <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-2xl sm:rounded-3xl p-6 sm:p-8 shadow-lg">
        <h1 id="result-title" class="font-impact italic text-primary text-3xl sm:text-4xl font-bold mb-2" style="font-family: Impact, 'Arial Black', sans-serif;"></h1>
        <p id="result-subtitle" class="text-lg sm:text-xl text-gray-700 mb-3"></p>
        <div class="flex flex-wrap gap-2 text-sm sm:text-base text-gray-600" id="result-tags"></div>
      </div>

      <div id="rankings-container" class="grid gap-6 md:gap-8"></div>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  document.addEventListener('DOMContentLoaded', async () => {
    const detailRoot = document.getElementById('detail-root');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const detailContent = document.getElementById('detail-content');
    const rankingsContainer = document.getElementById('rankings-container');

    const athleteId = Number(detailRoot?.dataset?.athleteId);
    const meetId = Number(detailRoot?.dataset?.meetId);
    const eventName = detailRoot?.dataset?.eventName || '';
    const resultType = detailRoot?.dataset?.resultType || 'Final';

    if (!Number.isFinite(athleteId) || !Number.isFinite(meetId) || !eventName) {
      console.error('Missing identifiers for result detail view.');
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
      return;
    }

    try {
      const params = new URLSearchParams({
        meet_id: meetId,
        event: eventName,
        result_type: resultType,
      });

      const response = await fetch(`/api/athletes/${athleteId}/result-rankings?${params.toString()}`);
      if (!response.ok) {
        throw new Error('Ranking data not found');
      }

      const data = await response.json();
      if (!data || !data.rankings) {
        throw new Error('Incomplete ranking payload');
      }

      loadingState.classList.add('hidden');
      detailContent.classList.remove('hidden');

      renderSummary(data);
      renderRankings(data.rankings, rankingsContainer);
    } catch (error) {
      console.error('Error loading ranking detail:', error);
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
    }

    function renderSummary(data) {
      const { context, target_result: target } = data;
      const titleEl = document.getElementById('result-title');
      const subtitleEl = document.getElementById('result-subtitle');
      const tagsEl = document.getElementById('result-tags');

      titleEl.textContent = `${context.event} • ${context.meet_type}`;

      const placeText = target.place ? `Placed ${ordinal(target.place)}` : 'Placement unavailable';
      subtitleEl.textContent = `${target.result} (${context.result_type}) — ${placeText}`;

      tagsEl.innerHTML = '';
      tagsEl.appendChild(buildTag(`Year: ${context.year}`));
      tagsEl.appendChild(buildTag(`Gender: ${context.gender || 'N/A'}`));
      if (target.school_name) {
        tagsEl.appendChild(buildTag(`School: ${target.school_name}`));
      }
      if (target.enrollment) {
        tagsEl.appendChild(buildTag(`Enrollment: ${target.enrollment}`));
      }
      if (target.meet_host) {
        const host = target.meet_host + (target.meet_num ? ` (Meet ${target.meet_num})` : '');
        tagsEl.appendChild(buildTag(`Meet Host: ${host}`));
      }
    }

    function renderRankings(rankings, container) {
      container.innerHTML = '';

      const configs = [
        { key: 'overall', title: 'Overall Field', description: 'How this result stacks up against the full field at the meet.' },
        { key: 'like_schools', title: 'Similar Enrollment', description: 'Comparison against schools with comparable enrollment sizes.' },
        { key: 'same_grade', title: 'Same Grade', description: 'Comparison against athletes in the same grade.' },
      ];

      configs.forEach(config => {
        const rankingData = rankings[config.key];
        const card = document.createElement('div');
        card.className = 'card bg-base-100 shadow-xl';

        const body = document.createElement('div');
        body.className = 'card-body space-y-4';

        const header = document.createElement('div');
        const title = document.createElement('h2');
        title.className = 'card-title text-primary text-xl sm:text-2xl';
        title.textContent = config.title;
        header.appendChild(title);

        const description = document.createElement('p');
        description.className = 'text-sm text-gray-600';
        description.textContent = config.description;
        header.appendChild(description);

        body.appendChild(header);

        if (!rankingData) {
          const empty = document.createElement('p');
          empty.className = 'text-sm text-gray-500 italic';
          empty.textContent = 'Not enough data to generate this ranking.';
          body.appendChild(empty);
        } else {
          const headline = document.createElement('p');
          headline.className = 'text-lg sm:text-xl font-semibold text-gray-800';
          headline.textContent = `Ranked ${rankingData.rank} of ${rankingData.total}`;
          body.appendChild(headline);

          if (rankingData.criteria) {
            const chips = document.createElement('div');
            chips.className = 'flex flex-wrap gap-2 text-xs sm:text-sm';
            Object.entries(rankingData.criteria).forEach(([key, value]) => {
              chips.appendChild(buildTag(`${formatLabel(key)}: ${value}`));
            });
            body.appendChild(chips);
          }

          body.appendChild(buildLeaderboardTable(rankingData.top_results));
        }

        card.appendChild(body);
        container.appendChild(card);
      });
    }

    function buildLeaderboardTable(entries) {
      const wrapper = document.createElement('div');
      wrapper.className = 'overflow-x-auto';

  const table = document.createElement('table');
  table.className = 'table table-compact w-full';

      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr class="text-primary text-xs sm:text-sm uppercase">
          <th class="w-16">Rank</th>
          <th>Athlete</th>
          <th class="hidden sm:table-cell">School</th>
          <th>Result</th>
          <th class="hidden md:table-cell">Place</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      entries.forEach(entry => {
  const tr = document.createElement('tr');
  tr.className = entry.is_target ? 'bg-red-100 text-red-700 font-semibold' : '';

        const rankTd = document.createElement('td');
        rankTd.textContent = entry.rank;
        rankTd.className = 'text-xs sm:text-sm';
        tr.appendChild(rankTd);

        const nameTd = document.createElement('td');
        nameTd.className = 'text-xs sm:text-sm';
        nameTd.textContent = entry.name || '—';
        tr.appendChild(nameTd);

        const schoolTd = document.createElement('td');
        schoolTd.className = 'hidden sm:table-cell text-xs sm:text-sm';
        schoolTd.textContent = entry.school || '—';
        tr.appendChild(schoolTd);

        const resultTd = document.createElement('td');
        resultTd.className = 'text-xs sm:text-sm';
        resultTd.textContent = entry.result || '—';
        tr.appendChild(resultTd);

        const placeTd = document.createElement('td');
        placeTd.className = 'hidden md:table-cell text-xs sm:text-sm';
        placeTd.textContent = entry.place != null ? ordinal(entry.place) : '—';
        tr.appendChild(placeTd);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      return wrapper;
    }

    function buildTag(text) {
      const span = document.createElement('span');
      span.className = 'badge badge-outline rounded-full px-3 py-2';
      span.textContent = text;
      return span;
    }

    function formatLabel(label) {
      return label.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
    }

    function ordinal(value) {
      if (value == null) return '—';
      const n = Number(value);
      if (!Number.isFinite(n)) return '—';
      const mod100 = n % 100;
      const suffix = (mod100 >= 11 && mod100 <= 13)
        ? 'th'
        : { 1: 'st', 2: 'nd', 3: 'rd' }[n % 10] || 'th';
      return `${n}${suffix}`;
    }
  });
</script>
{% endblock %}
